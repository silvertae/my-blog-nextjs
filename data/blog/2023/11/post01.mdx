---
title: '웹폰트 로딩시 출렁이는 현상 해결하기'
date: '2023-11-06'
tags: ['Font Optimization', 'FOUT', 'font display', next/font]
draft: false
summary: '블로그를 만들면서 처음 페이지 로드시 폰트가 출렁이는 현상을 발견했다. 이를 개선할 수 있는 다양한 방법들을 알아보고 직접 적용해보자.'
---

## 목차

- [Intro](#intro)
- [문제 원인](#문제-원인)
  - [FOUT vs FOIT](#fout-vs-foit)
  - [font-display](#font-display)

- [해결 방법](#해결-방법)
  - [서브셋 폰트로 파일 용량 줄이기](#서브셋-폰트로-파일-용량-줄이기)
  - [그 외 폰트 관련 속성들](#폰트-관련-속성)

- [결론](#결론)
- [Reference](#reference)

## Intro

![before gif](/static/gifs/font-error-before.gif)

위 gif를 보면 주소창에 블로그 url을 입력해서 처음 페이지가 렌더링 될 때 폰트가 변하면서 출렁이는게 보인다.
왜 이런 현상이 발생하고 어떻게 해결해야 할지 찾아보았다.

### 어떤 문제가 있었는가?

처음 블로그를 만들고 나서 몇가지 수정을 하면서 기존 템플릿에 설정된 폰트가 마음에 안들어서 좀 더 깔끔한 폰트로 바꾸고 싶었다.
블로그를 만들때 Next.js와 tailwind를 사용한 [블로그 템플릿](https://github.com/timlrx/tailwind-nextjs-starter-blog)을 사용했는데 폰트 설정이 어떻게 되어있나 찾아보니 다음과 같이 되어있었다.

```tsx
// app/layout.tsx
import { Space_Grotesk } from 'next/font/google'

const space_grotesk = Space_Grotesk({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-space-grotesk',
})
```

Next.js를 사용해보는게 처음이었기 때문에 공식문서를 찾아보니 next/font 라는 자체적인 Font Module을 가지고 있었다.
전에는 `@next/font` 라는 패키지를 따로 설치해야 사용이 가능했는데, Next.js 13.2 버전 이후로 기본적으로 제공하는 Built-in next/font를 이용해서 [Font Optimization](https://nextjs.org/docs/app/building-your-application/optimizing/fonts#local-fonts)을 제공하고 있었다.

나는 블로그에 Google Font에서 제공하는 폰트가 아닌 아닌 [Pretendard](https://github.com/orioncactus/pretendard) 폰트를 적용하고 싶었기 때문에
`public/static/fonts` 폴더에 미리 다운받은 `PretendardVariable.woff2` 파일을 넣어두고 next/font에서 제공하는 localFont 설정에 맞는 방식으로 수정 후에 다시 빌드해서 배포하였다.

```tsx
// app/layout.tsx
import localFont from 'next/font/local'

const pretendard = localFont({
  src: '../public/static/fonts/PretendardVariable.woff2',
  display: 'swap',
  variable: '--font-pretendard',
})
```

그리고 새롭게 배포된 블로그를 확인해보는데 이전에 없었던 폰트가 출렁이는 것처럼 보이는 현상을 발견했다.
Pretendard 폰트를 다운받아 오는 동안 기본으로 설정된 다른 폰트로 표시되었다가 폰트 스타일이 바뀌면서 화면에 출렁이는 것처럼 표시되는 것 같았다.

## 문제 원인

문제 원인은 조금만 찾아보니 알 수 있었는데 next/font에 의해 디폴트로 설정된 `font-display: swap` 속성과 해당 폰트를 로드해오는 시간때문이었다. 

그리고 앞에서 봤던 폰트 스타일이 변하면서 출렁이는 것처럼 보이는 현상을 FOUT(Flash Of Unstyled Text)라고 부른다는 것을 알게되었다.

### FOUT vs FOIT

브라우저는 웹페이지를 렌더링 할 때 설정된 웹폰트가 로드되지 않았으면 해당 텍스트의 렌더링을 차단하는데, 이러한 렌더링 차단 처리 방식은 브라우저마다 차이가 있다.

Chrome과 Firefox에서는 최대 3초의 timeout을 두고 텍스트를 화면에 표시하지 않다가 웹폰트 로딩이 완료되면 텍스트를 로드된 웹폰트로 대체하는 **FOIT(Flash Of Invisible Text)** 방식으로 렌더링을 차단한다. 만약 3초가 지날때까지 웹폰트가 로딩되지 않으면 브라우저 기본 대체 폰트로 텍스트를 표시한다. 

Internet Explorer 계열 브라우저는 timeout이 0초로 우선 웹폰트가 로딩될 때까지 대체 폰트를 사용해서 보여주고 후에 웹폰트가 로딩되면 텍스트를 웹폰트로 전환하는 **FOUT(Flash Of Unstyled Text)** 방식으로 렌더링 차단을 처리한다.

(Safari 브라우저 이러한 timeout이 없고 기준 네트워크 시간 제한을 초과했을 때의 동작도 없다고 한다? 🤔)

결국 웹폰트를 렌더링할 때 텍스트가 번쩍이는 현상(flash of text)이 일어나는데, 이것이 아무것도 보이지 않는 상태에서 웹폰트가 나타나며 번쩍이느냐(FOIT), 대체 폰트에서 웹폰트로 스타일이 바뀌면서 번쩍이느냐(FOUT)의 차이라고 볼 수 있다.

나는 크롬 브라우저를 이용하고 있음에도 FOIT이 아닌 FOUT 방식으로 렌더링 차단이 된 것인데, 그 이유는 `next/font`에서 기본적으로 제공하는 `font-display` 속성이 `swap`으로 적용돼 있었기 때문이다.

### font-display

MDN 설명에 따르면 `font-display`는 font face가 표시되는 방법을 결정하는 속성이다. 즉, 브라우저에서 폰트를 다운로드 해오는 시간동안 화면상에 텍스트를 어떻게 렌더링할지 결정하는 css 속성이다.

font-display는 폰트 다운로드의 타임라인을 폰트 차단 기간(font block period) -> 폰트 교체 기간(font swap period) -> 폰트 실패 기간(font failure period) 세 가지 기간으로 나눈다.

![font-display](/static/images/font-display.png)

*font-display 한눈에 보기(https://www.sertmedia.com/how-does-font-display-work/)*

font-display에는 auto(default), block, swap, fallback, option 이렇게 5가지 설정이 가능한데, 여기서는 block, swap 두 가지 방식에 대해서만 간단히 비교하고 넘어가고자 한다.

먼저 block은 

font-display 속성이 swap으로 설정돼 있으면 브라우저가 폰트를 다운받는 동안 대체 폰트로 텍스트를 표시하고 폰트 다운로드가 완료되면 설정한 폰트로 텍스트를 표시해준다.

## 해결 방법

### 서브셋 폰트로 파일 용량 줄이기

![before subset](/static/images/before-subset.png)

![after subset](/static/images/after-subset.png)

### 대체 폰트와 스타일 차이 줄이기

font style matcher

### `preload` 속성 활용하기

## 결론

- 폰트가 출렁이던 현상은 FOUT에 의한 것
- 불필요한 Glyph를 줄인 subset 폰트를 사용하면 폰트 로딩 시간을 줄여 사용자 경험을 향상시킬 수 있다.

---

## Reference

[How @next/font works](https://blog.mathpresso.com/how-next-font-works-8bb72c2bae39)

https://d2.naver.com/helloworld/4969726

https://developer.chrome.com/blog/font-display

[지연 시간 없이 웹폰트 서빙하기 - Feat. Safari & Edge functions | 뱅크샐러드](https://blog.banksalad.com/tech/font-preload-on-safari/)

